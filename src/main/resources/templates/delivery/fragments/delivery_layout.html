<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE">Delivery Panel - Mộc Việt</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <link rel="stylesheet" th:href="@{/css/delivery.css}">

</head>
<body>
    <div class="d-flex">

        <div th:replace="~{delivery/fragments/delivery_sidebar :: sidebar}"></div>

        <div class="main-content w-100">

            <div th:replace="~{delivery/fragments/delivery_header :: header}"></div>

            <main class="p-4" layout:fragment="content">

                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                     <i class="bi bi-check-circle-fill me-2"></i> <span th:text="${successMessage}"></span>
                     <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                 <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                     <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${errorMessage}"></span>
                     <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationList = document.getElementById('notificationList');
            const notificationPlaceholder = document.getElementById('notificationPlaceholder'); // Mục "Đang tải..." / "Không có..."

            // --- Hàm lấy và cập nhật thông báo ---
            function fetchNotifications() {
                fetch('/delivery/api/notifications/unread')
                    .then(response => {
                        if (!response.ok) { throw new Error('Network response was not ok'); }
                        return response.json();
                     })
                    .then(data => {
                        window._notiCacheArray = (data.notifications||[]); // cache toàn bộ để show detail
                        updateNotificationUI(window._notiCacheArray || []);
                    })
                    .catch(error => {
                        console.error('Error fetching notifications:', error);
                         if (notificationPlaceholder) notificationPlaceholder.textContent = "Lỗi tải thông báo";
                         if (notificationBadge) notificationBadge.style.display = 'none';
                    });
            }

            // --- Hàm cập nhật giao diện thông báo ---
            function updateNotificationUI(notifications) {
                let unreadCount = Array.isArray(notifications) ? notifications.length : 0;

                // Cập nhật badge
                if (notificationBadge) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.style.display = unreadCount > 0 ? 'block' : 'none';
                }

                // Cập nhật dropdown list
                if (notificationList) {
                    // Xóa các thông báo cũ (li.notification-item)
                    const items = notificationList.querySelectorAll('li.notification-item');
                    items.forEach(item => item.remove());

                    const divider = notificationList.querySelector('.dropdown-divider');

                    if (unreadCount > 0) {
                         if(notificationPlaceholder) notificationPlaceholder.style.display = 'none'; // Ẩn placeholder

                        notifications.slice(0, 7).forEach(noti => { // Hiển thị tối đa 7
                            const listItem = document.createElement('li');
                            listItem.classList.add('notification-item');
                            listItem.innerHTML = `
                                <a class="dropdown-item small ${noti.isRead ? 'text-muted' : ''}" href="#" onclick="showNotificationDetail(event, ${noti.id})">
                                    <div class="fw-bold">${noti.title || 'Thông báo'}</div>
                                    <div class="message-preview text-wrap" style="font-size: 0.9em;">${noti.message ? noti.message.substring(0, 100) + (noti.message.length > 100 ? '...' : '') : ''}</div>
                                    <div class="text-muted" style="font-size: 0.8em;">${formatTimeAgo(noti.createdAt)}</div>
                                </a>`;
                             if (divider && divider.parentNode === notificationList) {
                                notificationList.insertBefore(listItem, divider);
                            } else {
                                 notificationList.appendChild(listItem);
                             }
                        });
                    } else {
                         if(notificationPlaceholder) {
                            notificationPlaceholder.textContent = "Không có thông báo mới";
                            notificationPlaceholder.style.display = 'block'; // Hiện placeholder
                            notificationPlaceholder.classList.remove('disabled'); // Cho phép click (nếu có link)
                        }
                    }
                }
            }

            // --- Hàm đánh dấu đã đọc một thông báo ---
            window.markNotificationRead = function(event, notificationId) {
                 event.preventDefault();
                 event.stopPropagation();

                console.log(`Marking notification ${notificationId} as read`);
                const targetElement = event.currentTarget;
                if (!targetElement.classList.contains('text-muted')) { // Chỉ xử lý nếu chưa đọc
                    targetElement.classList.add('text-muted'); // Đánh dấu đã đọc tạm thời

                    fetch(`/delivery/api/notifications/${notificationId}/mark-read`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                let currentCount = parseInt(notificationBadge.textContent || '0');
                                if (currentCount > 0) {
                                     currentCount--;
                                     notificationBadge.textContent = currentCount;
                                     if (currentCount === 0) {
                                        notificationBadge.style.display = 'none';
                                        if (notificationPlaceholder) {
                                             notificationPlaceholder.textContent = "Không có thông báo mới";
                                             notificationPlaceholder.style.display = 'block';
                                        }
                                    }
                                }
                            } else {
                                 console.error("Failed to mark notification as read");
                                 targetElement.classList.remove('text-muted'); // Hoàn tác nếu lỗi
                            }
                        })
                         .catch(error => {
                             console.error('Error marking notification read:', error);
                             targetElement.classList.remove('text-muted'); // Hoàn tác nếu lỗi
                         });
                }
                // Optional: Chuyển hướng đến trang chi tiết đơn hàng nếu cần
                // let orderIdMatch = targetElement.querySelector('.message-preview').textContent.match(/#(\d+)/);
                // if(orderIdMatch && orderIdMatch[1]) {
                //     window.location.href = `/delivery/orders/${orderIdMatch[1]}`; // Cần lấy orderDeliveryId thay vì orderId
                // }
            }

            // --- Hàm đánh dấu TẤT CẢ đã đọc ---
            window.markAllNotificationsRead = function(event) {
                event.preventDefault();
                console.log('Marking all notifications as read');

                fetch('/delivery/api/notifications/mark-all-read', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.updatedCount > 0) { // Chỉ cập nhật UI nếu thực sự có thay đổi
                            notificationBadge.textContent = '0';
                            notificationBadge.style.display = 'none';
                            notificationList.querySelectorAll('.notification-item a:not(.text-muted)').forEach(link => {
                                link.classList.add('text-muted');
                            });
                             if (notificationPlaceholder) {
                                 notificationPlaceholder.textContent = "Không có thông báo mới";
                                 notificationPlaceholder.style.display = 'block';
                             }
                        } else if (!data.success) {
                            alert('Lỗi khi đánh dấu tất cả đã đọc.');
                        }
                    })
                    .catch(error => {
                         console.error('Error marking all read:', error);
                         alert('Lỗi khi đánh dấu tất cả đã đọc.');
                    });
            }

            // BỔ SUNG KHUNG TOAST THÔNG BÁO nhỏ bên dưới chuông
            const toastId = 'deliveryNotiToast';
            if (!document.getElementById(toastId)) {
              const toastBox = document.createElement('div');
              toastBox.id = toastId;
              toastBox.style = 'position: fixed; top: 70px; right: 35px; min-width: 280px; z-index: 1051; display: none;';
              toastBox.innerHTML = `<div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" style="min-width:280px;">
                  <div class="toast-header">
                    <strong class="me-auto">Chi tiết thông báo</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Đóng"></button>
                  </div>
                  <div class="toast-body" id="toastDetailContent"></div>
                </div>`;
              document.body.appendChild(toastBox);
            }

            // --- TẠO hoặc cập nhật khung TOAST chi tiết ở giữa TOP trang ---
            function ensureNotificationToastElement() {
              let toastBox = document.getElementById('deliveryNotiToast');
              if (!toastBox) {
                toastBox = document.createElement('div');
                toastBox.id = 'deliveryNotiToast';
                toastBox.style = '';
                document.body.appendChild(toastBox);
              }
              toastBox.style = 'position: fixed; left: 50%; transform: translate(-50%, 0); top: 6vh; z-index: 2000; min-width: 340px; max-width:90vw; background: #fff; border-radius: 14px; box-shadow: 0 4px 24px rgba(50,50,50,0.17); display: none;';
              toastBox.innerHTML = `
                <div style="padding: 16px 20px 16px 20px; max-width: 420px; min-width: 320px;">
                  <div style="display: flex; align-items:center; justify-content: space-between; border-bottom: 1px solid #e4e4e4; padding-bottom:8px; margin-bottom:6px;">
                    <span class="fw-bold" style="font-size: 1.36rem;">Chi tiết thông báo</span>
                    <button type="button" class="btn-close" aria-label="Đóng" style="font-size:1.3em;"></button>
                  </div>
                  <div id="toastDetailContent"></div>
                </div>`;
            }

            // --- Hiện chi tiết thông báo ở Toast giữa Top ---
            window.showNotificationDetail = function(event, notificationId) {
                if (event && typeof event.preventDefault === 'function') {
                    event.preventDefault();
                    if(typeof event.stopPropagation === 'function') event.stopPropagation();
                }
                const notiObj = window._notiCacheArray && window._notiCacheArray.find(n => n.id === notificationId);
                ensureNotificationToastElement();
                const toastBox = document.getElementById('deliveryNotiToast');
                const contentNode = document.getElementById('toastDetailContent');
                if (!notiObj || !toastBox || !contentNode) {
                    alert('Không tìm thấy đối tượng để hiển thị chi tiết!');
                    return;
                }
                console.log('Chi tiết notification hiển thị:', notiObj, contentNode);
                let msg = (typeof notiObj.message === 'string' ? notiObj.message : '');
                if (!msg.trim()) msg = '<i>(Không có nội dung)</i>';
                let title = notiObj.title || 'Thông báo';
                contentNode.style.background = '#fff';
                contentNode.style.border = '1px solid #e54444';
                contentNode.style.color = '#222';
                contentNode.style.padding = '6px 0 6px 0';
                contentNode.innerHTML =
                    `<div class='fw-bold mb-2' style='font-size: 1.08em;'>${title}</div>`+
                    `<div style='font-size: 1.08em;'>${msg}</div>`+
                    `<div class='text-muted mt-2' style='font-size:0.96em;'>${formatTimeAgo(notiObj.createdAt)}</div>`;
                toastBox.style.display = 'block';
                toastBox.style.background = '#fff';
                const btn = toastBox.querySelector('.btn-close');
                btn.onclick = function() {
                    window._notiCacheArray = (window._notiCacheArray||[]).filter(n => n.id !== notificationId);
                    updateNotificationUI(window._notiCacheArray);
                    fetch(`/delivery/api/notifications/${notificationId}/mark-read`, { method: 'POST' });
                    toastBox.style.display = 'none';
                };
            }

            // --- THÊM CSS badge đỏ nổi bật ---
            function applyNotificationBadgeStyle() {
               const style=document.createElement('style');
               style.innerHTML = `#notificationBadge, .notification-badge { background: #dc3545 !important; color: #fff !important; }`;
               document.head.appendChild(style);
            }
            applyNotificationBadgeStyle();

            // --- Hàm định dạng thời gian ---
            function formatTimeAgo(dateString) {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                     if (isNaN(date.getTime())) return ''; // Kiểm tra ngày hợp lệ

                    const now = new Date();
                    const seconds = Math.round((now - date) / 1000);
                    const minutes = Math.round(seconds / 60);
                    const hours = Math.round(minutes / 60);
                    const days = Math.round(hours / 24);

                    if (seconds < 60) return `${seconds} giây trước`;
                    if (minutes < 60) return `${minutes} phút trước`;
                    if (hours < 24) return `${hours} giờ trước`;
                    if (days === 1) return `hôm qua`;
                    if (days < 7) return `${days} ngày trước`;
                    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                } catch (e) {
                    console.error("Error formatting date:", dateString, e);
                    return ''; // Trả về chuỗi rỗng nếu có lỗi
                }
            }

            // --- Khởi chạy ---
            fetchNotifications(); // Lấy thông báo lần đầu
            setInterval(fetchNotifications, 1 * 60 * 1000); // Lấy lại mỗi 1 phút
        });
        </script>
    </th:block>
    </body>
</html>