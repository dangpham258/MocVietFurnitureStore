<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{manager/fragments/manager_layout}">
<head>
    <title>Quản lý Đánh giá - Manager</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="manager-content">
            <!-- Header -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-star"></i> Quản lý Đánh giá
                </h1>
                <div class="page-actions">
                    <a th:href="@{/manager/reviews/alerts}" class="btn btn-warning">
                        <i class="fas fa-bell"></i> Cảnh báo
                        <span class="badge bg-danger" th:if="${stats.unansweredReviews > 0}" 
                              th:text="${stats.unansweredReviews}"></span>
                    </a>
                </div>
            </div>
            
            <!-- Alert Messages -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <!-- Dashboard Stats - Premium KPI Cards -->
            <div class="row g-4 mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="review-kpi-card">
                        <div class="kpi-icon-wrapper kpi-gold">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-number" th:text="${stats.totalReviews}">0</div>
                            <div class="kpi-label">Tổng đánh giá</div>
                            <div class="kpi-progress">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-warning" role="progressbar" 
                                         style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="review-kpi-card">
                        <div class="kpi-icon-wrapper kpi-amber">
                            <i class="fas fa-reply"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-number" th:text="${stats.unansweredReviews}">0</div>
                            <div class="kpi-label">Chưa trả lời</div>
                            <div class="kpi-progress">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-danger" role="progressbar" 
                                         th:style="'width: ' + ${stats.totalReviews > 0 ? (stats.unansweredReviews * 100.0 / stats.totalReviews) : 0} + '%'"
                                         th:attr="aria-valuenow=${stats.totalReviews > 0 ? (stats.unansweredReviews * 100.0 / stats.totalReviews) : 0}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="review-kpi-card">
                        <div class="kpi-icon-wrapper kpi-emerald">
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-number" th:text="${#numbers.formatDecimal(stats.averageRating, 1, 1)}">0.0</div>
                            <div class="kpi-label">Rating trung bình</div>
                            <div class="kpi-progress">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         th:style="'width: ' + ${stats.averageRating * 20} + '%'"
                                         th:attr="aria-valuenow=${stats.averageRating * 20}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="review-kpi-card">
                        <div class="kpi-icon-wrapper kpi-azure">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-number" th:text="${stats.newReviewsThisWeek}">0</div>
                            <div class="kpi-label">Mới trong tuần</div>
                            <div class="kpi-progress">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-info" role="progressbar" 
                                         th:style="'width: ' + ${stats.totalReviews > 0 ? (stats.newReviewsThisWeek * 100.0 / stats.totalReviews) : 0} + '%'"
                                         th:attr="aria-valuenow=${stats.totalReviews > 0 ? (stats.newReviewsThisWeek * 100.0 / stats.totalReviews) : 0}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Panel -->
            <div class="filter-panel mb-4">
                <form th:action="@{/manager/reviews/all}" method="get" class="filter-form">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" name="keyword" class="form-control" 
                                   placeholder="Tên sản phẩm, khách hàng..."
                                   th:value="${filter.keyword}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Sản phẩm</label>
                            <select name="productId" class="form-select">
                                <option value="">Tất cả</option>
                                <option th:each="product : ${products}" 
                                        th:value="${product.id}"
                                        th:text="${product.name}"
                                        th:selected="${filter.productId != null and filter.productId == product.id}"></option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Số sao</label>
                            <select name="rating" class="form-select">
                                <option value="">Tất cả</option>
                                <option value="5" th:selected="${filter.rating != null and filter.rating == 5}">★★★★★ (5 sao)</option>
                                <option value="4" th:selected="${filter.rating != null and filter.rating == 4}">★★★★☆ (4 sao)</option>
                                <option value="3" th:selected="${filter.rating != null and filter.rating == 3}">★★★☆☆ (3 sao)</option>
                                <option value="2" th:selected="${filter.rating != null and filter.rating == 2}">★★☆☆☆ (2 sao)</option>
                                <option value="1" th:selected="${filter.rating != null and filter.rating == 1}">★☆☆☆☆ (1 sao)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Trạng thái</label>
                            <select name="isHidden" class="form-select">
                                <option value="">Tất cả</option>
                                <option value="false" th:selected="${filter.isHidden != null and filter.isHidden == false}">Hiển thị</option>
                                <option value="true" th:selected="${filter.isHidden != null and filter.isHidden == true}">Đã ẩn</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Phản hồi</label>
                            <select name="unanswered" class="form-select">
                                <option value="false" th:selected="${filter.unanswered == null or !filter.unanswered}">Tất cả</option>
                                <option value="true" th:selected="${filter.unanswered != null and filter.unanswered}">Chưa trả lời</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Reviews Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        Danh sách đánh giá 
                        <span class="badge bg-secondary" th:text="${totalItems}">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div th:if="${reviews.empty}" class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Không có đánh giá nào.
                    </div>
                    
                    <div th:if="${!reviews.empty}" class="table-responsive">
                        <table class="table table-hover review-table">
                            <thead>
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="20%">Sản phẩm</th>
                                    <th width="15%">Khách hàng</th>
                                    <th width="8%">Rating</th>
                                    <th width="30%">Nội dung</th>
                                    <th width="12%">Thời gian</th>
                                    <th width="10%" class="text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="review, iterStat : ${reviews}" 
                                    th:classappend="${review.isHidden != null and review.isHidden ? 'table-secondary' : ''}">
                                    <td th:text="${iterStat.count + (currentPage * 15)}"></td>
                                    <td>
                                        <a th:href="@{/products/{slug}(slug=${review.productSlug})}" 
                                           target="_blank" th:text="${review.productName}"></a>
                                    </td>
                                    <td th:text="${review.customerName}"></td>
                                    <td>
                                        <div class="rating-stars">
                                            <span th:each="i : ${#numbers.sequence(1, 5)}"
                                                  th:classappend="${i <= review.rating ? 'star-filled' : 'star-empty'}">★</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="review-content">
                                            <p class="mb-1" th:text="${review.content ?: '(Không có nội dung)'}"></p>
                                            <img th:if="${review.imageUrl != null and review.imageUrl != ''}" 
                                                 th:src="${review.imageUrl}" 
                                                 class="review-image" 
                                                 alt="Review image">
                                        </div>
                                        <div th:if="${review.managerResponse}" class="manager-response mt-2">
                                            <strong><i class="fas fa-reply"></i> Phản hồi:</strong>
                                            <p class="mb-0" th:text="${review.managerResponse}"></p>
                                            <small class="text-muted" th:if="${review.responseAt != null}">
                                                Bởi <span th:text="${review.managerName ?: 'Manager'}"></span> - 
                                                <span th:text="${#temporals.format(review.responseAt, 'dd/MM/yyyy HH:mm')}"></span>
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <small th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
                                        <br>
                                        <span th:if="${review.isHidden != null and review.isHidden}" class="badge bg-secondary">
                                            <i class="fas fa-eye-slash"></i> Đã ẩn
                                        </span>
                                        <span th:if="${review.isHidden == null or !review.isHidden}" class="badge bg-success">
                                            <i class="fas fa-eye"></i> Hiển thị
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group-vertical" role="group">
                                            <!-- Trả lời -->
                                            <a th:if="${review.managerResponse == null}" 
                                               th:href="@{/manager/reviews/{id}/respond(id=${review.id})}"
                                               class="btn btn-sm btn-primary" title="Trả lời">
                                                <i class="fas fa-reply"></i>
                                            </a>
                                            <!-- Ẩn/Hiện -->
                                            <form th:action="@{/manager/reviews/{id}/toggle-visibility(id=${review.id})}" 
                                                  method="post" class="d-inline">
                                                <button type="submit" 
                                                        th:class="${review.isHidden != null and review.isHidden ? 'btn btn-sm btn-success' : 'btn btn-sm btn-warning'}"
                                                        th:title="${review.isHidden != null and review.isHidden ? 'Hiện' : 'Ẩn'}">
                                                    <i th:class="${review.isHidden != null and review.isHidden ? 'fas fa-eye' : 'fas fa-eye-slash'}"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div th:if="${totalPages > 1}" class="d-flex justify-content-center mt-4">
                        <nav>
                            <ul class="pagination">
                                <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                    <a class="page-link" 
                                       th:href="@{/manager/reviews/all(page=0, keyword=${filter.keyword}, productId=${filter.productId}, rating=${filter.rating}, isHidden=${filter.isHidden}, unanswered=${filter.unanswered})}">
                                        Đầu
                                    </a>
                                </li>
                                <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                    <a class="page-link" 
                                       th:href="@{/manager/reviews/all(page=${currentPage - 1}, keyword=${filter.keyword}, productId=${filter.productId}, rating=${filter.rating}, isHidden=${filter.isHidden}, unanswered=${filter.unanswered})}">
                                        Trước
                                    </a>
                                </li>
                                
                                <li class="page-item" 
                                    th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                    th:if="${i >= currentPage - 2 && i <= currentPage + 2}"
                                    th:classappend="${i == currentPage ? 'active' : ''}">
                                    <a class="page-link" 
                                       th:href="@{/manager/reviews/all(page=${i}, keyword=${filter.keyword}, productId=${filter.productId}, rating=${filter.rating}, isHidden=${filter.isHidden}, unanswered=${filter.unanswered})}"
                                       th:text="${i + 1}"></a>
                                </li>
                                
                                <li class="page-item" th:classappend="${currentPage >= totalPages - 1 ? 'disabled' : ''}">
                                    <a class="page-link" 
                                       th:href="@{/manager/reviews/all(page=${currentPage + 1}, keyword=${filter.keyword}, productId=${filter.productId}, rating=${filter.rating}, isHidden=${filter.isHidden}, unanswered=${filter.unanswered})}">
                                        Sau
                                    </a>
                                </li>
                                <li class="page-item" th:classappend="${currentPage >= totalPages - 1 ? 'disabled' : ''}">
                                    <a class="page-link" 
                                       th:href="@{/manager/reviews/all(page=${totalPages - 1}, keyword=${filter.keyword}, productId=${filter.productId}, rating=${filter.rating}, isHidden=${filter.isHidden}, unanswered=${filter.unanswered})}">
                                        Cuối
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

