<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{manager/fragments/manager_layout}">
<head>
    <title>Cảnh báo Đánh giá - Manager</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="manager-content">
            <!-- Header -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-bell"></i> Cảnh báo Đánh giá
                </h1>
                <div class="page-actions">
                    <a th:href="@{/manager/reviews/all}" class="btn btn-secondary">
                        <i class="fas fa-list"></i> Tất cả đánh giá
                    </a>
                </div>
            </div>
            
            <!-- Dashboard Stats - Premium KPI Cards -->
            <div class="row g-4 mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="review-kpi-card">
                        <div class="kpi-icon-wrapper kpi-amber">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-number" th:text="${alerts.size()}">0</div>
                            <div class="kpi-label">Tổng cảnh báo</div>
                            <div class="kpi-progress">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-warning" role="progressbar" 
                                         style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="review-kpi-card">
                        <div class="kpi-icon-wrapper kpi-red">
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-number" th:text="${stats.oneStarReviews + stats.twoStarReviews}">0</div>
                            <div class="kpi-label">Rating thấp (1-2★)</div>
                            <div class="kpi-progress">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-danger" role="progressbar" 
                                         th:style="'width: ' + ${stats.totalReviews > 0 ? ((stats.oneStarReviews + stats.twoStarReviews) * 100.0 / stats.totalReviews) : 0} + '%'"
                                         th:attr="aria-valuenow=${stats.totalReviews > 0 ? ((stats.oneStarReviews + stats.twoStarReviews) * 100.0 / stats.totalReviews) : 0}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="review-kpi-card">
                        <div class="kpi-icon-wrapper kpi-azure">
                            <i class="fas fa-reply"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-number" th:text="${stats.unansweredReviews}">0</div>
                            <div class="kpi-label">Chưa trả lời</div>
                            <div class="kpi-progress">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-info" role="progressbar" 
                                         th:style="'width: ' + ${stats.totalReviews > 0 ? (stats.unansweredReviews * 100.0 / stats.totalReviews) : 0} + '%'"
                                         th:attr="aria-valuenow=${stats.totalReviews > 0 ? (stats.unansweredReviews * 100.0 / stats.totalReviews) : 0}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="review-kpi-card">
                        <div class="kpi-icon-wrapper kpi-emerald">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-number" th:text="${#numbers.formatDecimal(stats.averageRating, 1, 1)}">0.0</div>
                            <div class="kpi-label">Rating trung bình</div>
                            <div class="kpi-progress">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         th:style="'width: ' + ${stats.averageRating * 20} + '%'"
                                         th:attr="aria-valuenow=${stats.averageRating * 20}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alerts List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        Danh sách cảnh báo
                        <span class="badge bg-warning text-dark" th:text="${alerts.size()}">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div th:if="${alerts.empty}" class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Tuyệt vời! Không có cảnh báo nào.
                    </div>
                    
                    <div th:if="${!alerts.empty}">
                        <div th:each="alert : ${alerts}" 
                             class="alert-item mb-3 p-3 border rounded"
                             th:classappend="${alert.priority == 'HIGH' ? 'border-danger' : 'border-warning'}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <!-- Priority Badge -->
                                    <span th:if="${alert.priority == 'HIGH'}" 
                                          class="badge bg-danger mb-2">
                                        <i class="fas fa-exclamation-circle"></i> Ưu tiên cao
                                    </span>
                                    <span th:if="${alert.priority == 'MEDIUM'}" 
                                          class="badge bg-warning text-dark mb-2">
                                        <i class="fas fa-info-circle"></i> Ưu tiên vừa
                                    </span>
                                    
                                    <!-- Alert Type -->
                                    <span th:if="${alert.alertType == 'LOW_RATING'}" 
                                          class="badge bg-danger mb-2">
                                        <i class="fas fa-star-half-alt"></i> Rating thấp
                                    </span>
                                    <span th:if="${alert.alertType == 'NEGATIVE_CONTENT'}" 
                                          class="badge bg-danger mb-2">
                                        <i class="fas fa-frown"></i> Nội dung tiêu cực
                                    </span>
                                    <span th:if="${alert.alertType == 'NEW_REVIEW'}" 
                                          class="badge bg-info mb-2">
                                        <i class="fas fa-comment"></i> Đánh giá mới
                                    </span>
                                    
                                    <!-- Review Info -->
                                    <h6 class="mb-2">
                                        <a th:if="${alert.productSlug != null}" 
                                           th:href="@{/products/{slug}(slug=${alert.productSlug})}" 
                                           target="_blank" 
                                           th:text="${alert.productName}"></a>
                                        <span th:if="${alert.productSlug == null}" th:text="${alert.productName}"></span>
                                    </h6>
                                    
                                    <p class="mb-2">
                                        <strong>Khách hàng:</strong> <span th:text="${alert.customerName ?: '(Không rõ)'}"></span>
                                        <span class="ms-3" th:if="${alert.rating != null}">
                                            <strong>Rating:</strong>
                                            <span th:each="i : ${#numbers.sequence(1, 5)}"
                                                  th:classappend="${i <= alert.rating ? 'star-filled' : 'star-empty'}">★</span>
                                        </span>
                                    </p>
                                    
                                    <div class="review-content-preview" th:if="${alert.content}">
                                        <p class="text-muted mb-1" th:text="${alert.content}"></p>
                                    </div>
                                    
                                    <small class="text-muted" th:if="${alert.createdAt != null}">
                                        <i class="fas fa-clock"></i>
                                        <span th:text="${#temporals.format(alert.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                    </small>
                                </div>
                                
                                <!-- Actions -->
                                <div class="ms-3">
                                    <div class="btn-group-vertical" role="group">
                                        <a th:href="@{/manager/reviews/{id}/respond(id=${alert.id})}"
                                           class="btn btn-sm btn-primary" title="Trả lời ngay">
                                            <i class="fas fa-reply"></i> Trả lời
                                        </a>
                                        <a th:href="@{/manager/reviews/all}"
                                           class="btn btn-sm btn-secondary" title="Xem chi tiết">
                                            <i class="fas fa-eye"></i> Chi tiết
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

