<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
</head>
<body>
<header th:fragment="header" class="sticky-top" style="z-index: 1030;">
    <div class="bg-dark text-white py-2">
        <div class="container">
            <div class="row">
                <div class="col-md-6 small d-flex align-items-center">
                    <span><i class="bi bi-telephone me-1"></i> Hotline: <a href="tel:0971141140" class="text-white text-decoration-none">0971 141 140</a></span>
                    <span class="ms-3"><i class="bi bi-envelope me-1"></i> <a href="mailto:cskh@mocviet.vn" class="text-white text-decoration-none">cskh@mocviet.vn</a></span>
                </div>
                <div class="col-md-6 text-end small">
                    <!-- Dropdown chỉ dành cho CUSTOMER -->
                    <span sec:authorize="isAuthenticated() and hasRole('CUSTOMER')">
                        <div class="dropdown d-inline-block">
                            <a class="text-white text-decoration-none dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle me-1"></i> Xin chào, <span sec:authentication="name">User</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="/notifications">
                                    <i class="bi bi-bell me-2"></i>Thông báo
                                    <span class="badge bg-danger rounded-pill ms-2" id="notificationBadge" style="display: none;">0</span>
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/customer/profile"><i class="bi bi-person-lines-fill me-2"></i>Thông tin cá nhân</a></li>
                                <li><a class="dropdown-item" href="/customer/orders"><i class="bi bi-box-seam me-2"></i>Đơn hàng của tôi</a></li>
                                <li><a class="dropdown-item" href="/customer/wishlist"><i class="bi bi-heart me-2"></i>Danh sách yêu thích</a></li>
                                <li><a class="dropdown-item" href="/customer/addresses"><i class="bi bi-geo-alt me-2"></i>Địa chỉ nhận hàng</a></li>
                                <li><a class="dropdown-item" href="/customer/viewed"><i class="bi bi-clock-history me-2"></i>Lịch sử xem</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
                            </ul>
                        </div>
                    </span>
                    <!-- Nút điều hướng nhanh theo vai trò (không hiển thị dropdown) -->
                    <span sec:authorize="isAuthenticated() and hasRole('ADMIN')">
                        <a href="/admin" class="btn btn-sm btn-warning fw-semibold ms-2">Đi tới trang Admin</a>
                        <a href="/logout" class="btn btn-sm btn-outline-light fw-semibold ms-2">
                            <i class="bi bi-box-arrow-right me-1"></i>Đăng xuất
                        </a>
                    </span>
                    <span sec:authorize="isAuthenticated() and hasRole('MANAGER')">
                        <a href="/manager" class="btn btn-sm btn-primary fw-semibold ms-2">Đi tới trang Manager</a>
                        <a href="/logout" class="btn btn-sm btn-outline-light fw-semibold ms-2">
                            <i class="bi bi-box-arrow-right me-1"></i>Đăng xuất
                        </a>
                    </span>
                    <span sec:authorize="isAuthenticated() and hasRole('DELIVERY')">
                        <a href="/delivery" class="btn btn-sm btn-success fw-semibold ms-2">Đi tới trang Delivery</a>
                        <a href="/logout" class="btn btn-sm btn-outline-light fw-semibold ms-2">
                            <i class="bi bi-box-arrow-right me-1"></i>Đăng xuất
                        </a>
                    </span>
                    <span sec:authorize="!isAuthenticated()">
                        <a href="/login" class="text-white text-decoration-none"><i class="bi bi-box-arrow-in-right me-1"></i>Đăng nhập</a> /
                        <a href="/register" class="text-white text-decoration-none"><i class="bi bi-person-plus me-1"></i>Đăng ký</a>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold fs-4" href="/" style="color: #8B4513;">
                <img src="/static/images/logo/MVlogo.jpg" alt="Logo Mộc Việt" class="d-inline-block align-text-top me-1" style="width:30px;height:30px;object-fit:cover;border-radius:4px;"> MỘC VIỆT
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarMain">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Trang chủ</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="productDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Sản phẩm
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="productDropdown">
                            <li><a class="dropdown-item" th:href="@{/products(categorySlug='phong-khach')}">Phòng khách</a></li>
                            <li><a class="dropdown-item" th:href="@{/products(categorySlug='phong-ngu')}">Phòng ngủ</a></li>
                            <li><a class="dropdown-item" th:href="@{/products(categorySlug='phong-an')}">Phòng ăn</a></li>
                            <li><a class="dropdown-item" th:href="@{/products(categorySlug='phong-lam-viec')}">Phòng làm việc</a></li>
                            <li><a class="dropdown-item" th:href="@{/products(categorySlug='tu-bep')}">Tủ bếp</a></li>
                             <li><hr class="dropdown-divider"></li>
                             <li><a class="dropdown-item" th:href="@{/products}">Tất cả sản phẩm</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/gioi-thieu">Về Mộc Việt</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/news">Tin tức</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/showroom">Showroom</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/contact">Liên hệ</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <a href="/products" class="btn btn-link text-dark me-2" title="Tìm kiếm">
                        <i class="bi bi-search fs-5"></i>
                    </a>
                    <a href="/customer/cart" class="btn btn-link text-dark position-relative" title="Giỏ hàng">
                        <i class="bi bi-cart3 fs-5"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-count"
                              th:style="${globalCartCount} > 0 ? 'display: inline; font-size: 0.6em;' : 'display: none; font-size: 0.6em;'"
                              th:text="${globalCartCount}">0</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
</header>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<!-- Global Notification System -->
<script defer th:src="@{/js/notification.js}"></script>

<!-- Load notification count for authenticated users -->
<script th:if="${#authorization.expression('isAuthenticated()')}">
    document.addEventListener('DOMContentLoaded', function() {
        loadNotificationCount();
        
        // Refresh notification count every 30 seconds
        setInterval(loadNotificationCount, 30000);
    });
    
    let __lastUnreadCount = null;
    function loadNotificationCount() {
        fetch('/api/notifications/unread')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.notifications) {
                    const count = data.notifications.length;
                    const badge = document.getElementById('notificationBadge');
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }

                    // Thông báo khi có thông báo mới tăng lên
                    if (__lastUnreadCount !== null && count > __lastUnreadCount && window.showNotification) {
                        const added = count - __lastUnreadCount;
                        window.showNotification(`Bạn có ${added} thông báo mới`, 'info', 3000);
                    }
                    __lastUnreadCount = count;
                }
            })
            .catch(error => console.error('Error loading notification count:', error));
    }
</script>

<!-- Cart count: luôn tải để tránh phụ thuộc file JS từng trang -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        updateCartCountInHeader();
        // Refresh định kỳ để tránh lệch trạng thái khi thêm từ trang khác
        setInterval(updateCartCountInHeader, 15000);

        // Khi quay lại tab, đồng bộ lại
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                updateCartCountInHeader();
            }
        });
    });

    function updateCartCountInHeader() {
        fetch('/api/cart/count')
            .then(r => r.json())
            .then(data => {
                if (data && data.success) {
                    const count = data.count || 0;
                    const els = document.querySelectorAll('.cart-count');
                    els.forEach(el => {
                        el.textContent = count;
                        el.style.display = count > 0 ? 'inline' : 'none';
                    });
                }
            })
            .catch(err => console.error('Error loading cart count:', err));
    }
</script>

</body>
</html>

