-- =====================================================
-- MOC VIET - D·ªÆ LI·ªÜU M·∫™U CHO CH·ª®C NƒÇNG THU H·ªíI H√ÄNG
-- =====================================================
-- Script n√†y t·∫°o d·ªØ li·ªáu m·∫´u ƒë·ªÉ test ch·ª©c nƒÉng thu h·ªìi h√†ng (return pickup)
-- Ch·∫°y sau khi ƒë√£ c√≥ d·ªØ li·ªáu c∆° b·∫£n t·ª´ MocViet_Database_Sample.sql

USE MocViet;
GO

PRINT N'üöÄ B·∫Øt ƒë·∫ßu t·∫°o d·ªØ li·ªáu m·∫´u cho ch·ª©c nƒÉng thu h·ªìi h√†ng...';

BEGIN TRANSACTION;
SET NOCOUNT ON;

-- =====================================================
-- 1. T·∫†O ƒê∆†N H√ÄNG M·∫™U CHO THU H·ªíI
-- =====================================================

-- L·∫•y c√°c ID c·∫ßn thi·∫øt
DECLARE @userA INT = (SELECT id FROM dbo.Users WHERE username = N'cust_a');
DECLARE @userB INT = (SELECT id FROM dbo.Users WHERE username = N'cust_b');
DECLARE @managerID INT = (SELECT id FROM dbo.Users WHERE username = N'manager');
DECLARE @teamNam INT = (SELECT id FROM dbo.DeliveryTeam WHERE name = N'ƒê·ªôi Giao Khu V·ª±c Nam');
DECLARE @teamBac INT = (SELECT id FROM dbo.DeliveryTeam WHERE name = N'ƒê·ªôi Giao Khu V·ª±c B·∫Øc');

-- L·∫•y ƒë·ªãa ch·ªâ
DECLARE @addrA INT = (SELECT id FROM dbo.Address WHERE user_id = @userA);
DECLARE @addrB INT = (SELECT id FROM dbo.Address WHERE user_id = @userB);

-- L·∫•y m·ªôt s·ªë SKU c√≥ s·∫µn
DECLARE @sku1 INT = (SELECT id FROM dbo.ProductVariant WHERE sku = N'BANOC6_DEN');
DECLARE @sku2 INT = (SELECT id FROM dbo.ProductVariant WHERE sku = N'SO3_XAM');
DECLARE @sku3 INT = (SELECT id FROM dbo.ProductVariant WHERE sku = N'GN1M6_NAU');

-- =====================================================
-- ƒê∆†N H√ÄNG 1: ƒê√É GIAO TH√ÄNH C√îNG - CH·ªú THU H·ªíI
-- =====================================================

PRINT N'üì¶ T·∫°o ƒë∆°n h√†ng #1 - ƒê√£ giao th√†nh c√¥ng, ch·ªù thu h·ªìi...';

DECLARE @order1 INT;
DECLARE @items1 dbo.TVP_OrderItem;
INSERT INTO @items1(variant_id, qty) VALUES(@sku1, 1);

DECLARE @o1 TABLE(
  order_id INT,
  subtotal_snapshot DECIMAL(18,0),
  discount_amount DECIMAL(18,0),
  total_after_coupon DECIMAL(18,0),
  shipping_fee DECIMAL(12,0),
  grand_total DECIMAL(18,0)
);

INSERT INTO @o1 EXEC dbo.sp_CreateOrder 
  @user_id = @userA,
  @address_id = @addrA,
  @coupon_code = N'WELCOME10',
  @payment_method = N'COD',
  @items = @items1;

SELECT @order1 = order_id FROM @o1;

-- Thanh to√°n th√†nh c√¥ng
EXEC dbo.sp_HandlePaymentWebhook 
  @order_id = @order1,
  @payment_method = N'COD',
  @is_success = 1,
  @gateway_txn_code = N'COD_' + CAST(@order1 AS NVARCHAR(10));

-- X√°c nh·∫≠n v√† giao h√†ng th√†nh c√¥ng
EXEC dbo.sp_ConfirmOrder @order_id = @order1, @actor_user_id = @managerID;
EXEC dbo.sp_MarkDispatched @order_id = @order1, @delivery_team_id = @teamNam, @actor_user_id = @managerID;

DECLARE @proof1 NVARCHAR(255) = N'/static/images/deliveries/order-' + CAST(@order1 AS NVARCHAR(10)) + N'/delivered.jpg';
EXEC dbo.sp_MarkDelivered @order_id = @order1, @proof_image_url = @proof1, @actor_user_id = @managerID;

-- C·∫≠p nh·∫≠t payment_status = PAID (COD)
UPDATE dbo.Orders SET payment_status = N'PAID' WHERE id = @order1;

-- Kh√°ch h√†ng y√™u c·∫ßu tr·∫£ h√†ng
EXEC dbo.sp_RequestReturn
  @order_id = @order1,
  @customer_id = @userA,
  @reason = N'S·∫£n ph·∫©m kh√¥ng ƒë√∫ng m√†u s·∫Øc nh∆∞ m√¥ t·∫£ tr√™n website. T√¥i ƒë·∫∑t m√†u ƒëen nh∆∞ng nh·∫≠n ƒë∆∞·ª£c m√†u n√¢u.';

-- Manager ph√™ duy·ªát y√™u c·∫ßu tr·∫£ h√†ng
EXEC dbo.sp_ApproveReturn 
  @order_id = @order1, 
  @manager_id = @managerID, 
  @note = N'ƒê·ªìng √Ω tr·∫£ h√†ng, s·∫£n ph·∫©m kh√¥ng ƒë√∫ng m√¥ t·∫£ m√†u s·∫Øc',
  @delivery_team_id = @teamNam;

PRINT N'‚úÖ ƒê∆°n h√†ng #' + CAST(@order1 AS NVARCHAR(10)) + N' ƒë√£ s·∫µn s√†ng ƒë·ªÉ thu h·ªìi (RETURN_PICKUP)';

-- =====================================================
-- ƒê∆†N H√ÄNG 2: ƒê√É GIAO TH√ÄNH C√îNG - CH·ªú THU H·ªíI
-- =====================================================

PRINT N'üì¶ T·∫°o ƒë∆°n h√†ng #2 - ƒê√£ giao th√†nh c√¥ng, ch·ªù thu h·ªìi...';

DECLARE @order2 INT;
DECLARE @items2 dbo.TVP_OrderItem;
INSERT INTO @items2(variant_id, qty) VALUES(@sku2, 1);

DECLARE @o2 TABLE(
  order_id INT,
  subtotal_snapshot DECIMAL(18,0),
  discount_amount DECIMAL(18,0),
  total_after_coupon DECIMAL(18,0),
  shipping_fee DECIMAL(12,0),
  grand_total DECIMAL(18,0)
);

INSERT INTO @o2 EXEC dbo.sp_CreateOrder 
  @user_id = @userB,
  @address_id = @addrB,
  @coupon_code = NULL,
  @payment_method = N'VNPAY',
  @items = @items2;

SELECT @order2 = order_id FROM @o2;

-- Thanh to√°n VNPAY th√†nh c√¥ng
EXEC dbo.sp_HandlePaymentWebhook 
  @order_id = @order2,
  @payment_method = N'VNPAY',
  @is_success = 1,
  @gateway_txn_code = N'VNPAY_' + CAST(@order2 AS NVARCHAR(10));

-- X√°c nh·∫≠n v√† giao h√†ng th√†nh c√¥ng
EXEC dbo.sp_ConfirmOrder @order_id = @order2, @actor_user_id = @managerID;
EXEC dbo.sp_MarkDispatched @order_id = @order2, @delivery_team_id = @teamBac, @actor_user_id = @managerID;

DECLARE @proof2 NVARCHAR(255) = N'/static/images/deliveries/order-' + CAST(@order2 AS NVARCHAR(10)) + N'/delivered.jpg';
EXEC dbo.sp_MarkDelivered @order_id = @order2, @proof_image_url = @proof2, @actor_user_id = @managerID;

-- Kh√°ch h√†ng y√™u c·∫ßu tr·∫£ h√†ng
EXEC dbo.sp_RequestReturn
  @order_id = @order2,
  @customer_id = @userB,
  @reason = N'S·∫£n ph·∫©m b·ªã l·ªói k·ªπ thu·∫≠t, gh·∫ø kh√¥ng th·ªÉ ƒëi·ªÅu ch·ªânh ƒë·ªô cao nh∆∞ qu·∫£ng c√°o.';

-- Manager ph√™ duy·ªát y√™u c·∫ßu tr·∫£ h√†ng
EXEC dbo.sp_ApproveReturn 
  @order_id = @order2, 
  @manager_id = @managerID, 
  @note = N'ƒê·ªìng √Ω tr·∫£ h√†ng, s·∫£n ph·∫©m c√≥ l·ªói k·ªπ thu·∫≠t',
  @delivery_team_id = @teamBac;

PRINT N'‚úÖ ƒê∆°n h√†ng #' + CAST(@order2 AS NVARCHAR(10)) + N' ƒë√£ s·∫µn s√†ng ƒë·ªÉ thu h·ªìi (RETURN_PICKUP)';

-- =====================================================
-- ƒê∆†N H√ÄNG 3: ƒê√É GIAO TH√ÄNH C√îNG - CH·ªú THU H·ªíI
-- =====================================================

PRINT N'üì¶ T·∫°o ƒë∆°n h√†ng #3 - ƒê√£ giao th√†nh c√¥ng, ch·ªù thu h·ªìi...';

DECLARE @order3 INT;
DECLARE @items3 dbo.TVP_OrderItem;
INSERT INTO @items3(variant_id, qty) VALUES(@sku3, 1);

DECLARE @o3 TABLE(
  order_id INT,
  subtotal_snapshot DECIMAL(18,0),
  discount_amount DECIMAL(18,0),
  total_after_coupon DECIMAL(18,0),
  shipping_fee DECIMAL(12,0),
  grand_total DECIMAL(18,0)
);

INSERT INTO @o3 EXEC dbo.sp_CreateOrder 
  @user_id = @userA,
  @address_id = @addrA,
  @coupon_code = N'VIP20',
  @payment_method = N'MOMO',
  @items = @items3;

SELECT @order3 = order_id FROM @o3;

-- Thanh to√°n MOMO th√†nh c√¥ng
EXEC dbo.sp_HandlePaymentWebhook 
  @order_id = @order3,
  @payment_method = N'MOMO',
  @is_success = 1,
  @gateway_txn_code = N'MOMO_' + CAST(@order3 AS NVARCHAR(10));

-- X√°c nh·∫≠n v√† giao h√†ng th√†nh c√¥ng
EXEC dbo.sp_ConfirmOrder @order_id = @order3, @actor_user_id = @managerID;
EXEC dbo.sp_MarkDispatched @order_id = @order3, @delivery_team_id = @teamNam, @actor_user_id = @managerID;

DECLARE @proof3 NVARCHAR(255) = N'/static/images/deliveries/order-' + CAST(@order3 AS NVARCHAR(10)) + N'/delivered.jpg';
EXEC dbo.sp_MarkDelivered @order_id = @order3, @proof_image_url = @proof3, @actor_user_id = @managerID;

-- Kh√°ch h√†ng y√™u c·∫ßu tr·∫£ h√†ng
EXEC dbo.sp_RequestReturn
  @order_id = @order3,
  @customer_id = @userA,
  @reason = N'K√≠ch th∆∞·ªõc s·∫£n ph·∫©m kh√¥ng ph√π h·ª£p v·ªõi kh√¥ng gian ph√≤ng ng·ªß c·ªßa t√¥i.';

-- Manager ph√™ duy·ªát y√™u c·∫ßu tr·∫£ h√†ng
EXEC dbo.sp_ApproveReturn 
  @order_id = @order3, 
  @manager_id = @managerID, 
  @note = N'ƒê·ªìng √Ω tr·∫£ h√†ng, k√≠ch th∆∞·ªõc kh√¥ng ph√π h·ª£p',
  @delivery_team_id = @teamNam;

PRINT N'‚úÖ ƒê∆°n h√†ng #' + CAST(@order3 AS NVARCHAR(10)) + N' ƒë√£ s·∫µn s√†ng ƒë·ªÉ thu h·ªìi (RETURN_PICKUP)';

-- =====================================================
-- 2. T·∫†O TH√îNG B√ÅO CHO DELIVERY TEAM
-- =====================================================

PRINT N'üîî T·∫°o th√¥ng b√°o cho ƒë·ªôi giao h√†ng...';

-- Th√¥ng b√°o cho ƒë·ªôi giao Nam
DECLARE @deliveryUserNam INT = (SELECT id FROM dbo.Users WHERE username = N'delivery_south');
INSERT INTO dbo.UserNotification(user_id, title, message, is_read)
VALUES
(@deliveryUserNam, N'C√≥ ƒë∆°n h√†ng c·∫ßn thu h·ªìi', N'ƒê∆°n h√†ng #' + CAST(@order1 AS NVARCHAR(10)) + N' c·∫ßn thu h·ªìi t·ª´ kh√°ch h√†ng Tr·∫ßn Kh√°ch A', 0),
(@deliveryUserNam, N'C√≥ ƒë∆°n h√†ng c·∫ßn thu h·ªìi', N'ƒê∆°n h√†ng #' + CAST(@order3 AS NVARCHAR(10)) + N' c·∫ßn thu h·ªìi t·ª´ kh√°ch h√†ng Tr·∫ßn Kh√°ch A', 0);

-- Th√¥ng b√°o cho ƒë·ªôi giao B·∫Øc
DECLARE @deliveryUserBac INT = (SELECT id FROM dbo.Users WHERE username = N'delivery_north');
INSERT INTO dbo.UserNotification(user_id, title, message, is_read)
VALUES
(@deliveryUserBac, N'C√≥ ƒë∆°n h√†ng c·∫ßn thu h·ªìi', N'ƒê∆°n h√†ng #' + CAST(@order2 AS NVARCHAR(10)) + N' c·∫ßn thu h·ªìi t·ª´ kh√°ch h√†ng ƒê·ªó Kh√°ch B', 0);

-- =====================================================
-- 3. HI·ªÇN TH·ªä TH√îNG TIN ƒê·ªÇ TEST
-- =====================================================

PRINT N'üìã Th√¥ng tin c√°c ƒë∆°n h√†ng s·∫µn s√†ng ƒë·ªÉ thu h·ªìi:';

SELECT 
    N'ƒê∆°n h√†ng s·∫µn s√†ng thu h·ªìi' as Loai,
    o.id as OrderID,
    o.status as OrderStatus,
    o.return_status as ReturnStatus,
    o.payment_method as PaymentMethod,
    o.payment_status as PaymentStatus,
    u.full_name as CustomerName,
    u.phone as CustomerPhone,
    dt.name as DeliveryTeam,
    od.status as DeliveryStatus,
    od.note as DeliveryNote
FROM dbo.Orders o
JOIN dbo.Users u ON u.id = o.user_id
JOIN dbo.OrderDelivery od ON od.order_id = o.id
JOIN dbo.DeliveryTeam dt ON dt.id = od.delivery_team_id
WHERE o.return_status = N'APPROVED' 
  AND od.status = N'RETURN_PICKUP'
ORDER BY o.id;

PRINT N'üì± Th√¥ng tin ƒëƒÉng nh·∫≠p ƒë·ªÉ test:';
PRINT N'   üë§ Delivery Team Nam: username=delivery_south, password=demo123';
PRINT N'   üë§ Delivery Team B·∫Øc: username=delivery_north, password=demo123';
PRINT N'   üë§ Manager: username=manager, password=demo123';

PRINT N'üîó URL ƒë·ªÉ test:';
PRINT N'   üì± Delivery Dashboard: http://localhost:8080/delivery';
PRINT N'   üì± Chi ti·∫øt ƒë∆°n h√†ng: http://localhost:8080/delivery/orders/{orderId}';
PRINT N'   üì± API th√¥ng b√°o: http://localhost:8080/delivery/api/notifications';

COMMIT TRANSACTION;

PRINT N'üéâ Ho√†n th√†nh t·∫°o d·ªØ li·ªáu m·∫´u cho ch·ª©c nƒÉng thu h·ªìi h√†ng!';
PRINT N'';
PRINT N'üìù H∆Ø·ªöNG D·∫™N TEST:';
PRINT N'1. ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n delivery team';
PRINT N'2. V√†o Dashboard s·∫Ω th·∫•y c√°c ƒë∆°n h√†ng c√≥ tr·∫°ng th√°i "C·∫ßn thu h·ªìi"';
PRINT N'3. Click "Chi ti·∫øt" ƒë·ªÉ xem th√¥ng tin ƒë∆°n h√†ng';
PRINT N'4. Ch·ªçn ph∆∞∆°ng th·ª©c ho√†n ti·ªÅn v√† nh·∫≠p ghi ch√∫';
PRINT N'5. Click "X√ÅC NH·∫¨N ƒê√É THU H·ªíI" ƒë·ªÉ ho√†n t·∫•t';
PRINT N'';
PRINT N'‚úÖ Ch·ª©c nƒÉng thu h·ªìi h√†ng ƒë√£ s·∫µn s√†ng ƒë·ªÉ test!';
